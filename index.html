<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index</title>
    <link rel="stylesheet" href="/assets/bootstrap/v5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/fontawesome/v5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/sweetalert2/sweetalert2.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    
</head>
<body>
    <div class="container">
        <header>
            <div class="row col-lg-12">
                <div class="col-lg-5">
                    <h1>List of customers</h1>
                </div>
                <div class="col-lg-7">
                    <div class="col-lg-4">
                        <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#modalCreateCustomer">
                            Add new customer
                        </button>
                    </div>
                    <div class="col-lg-4">
                        <button class="btn btn-outline-light">
                            Transfer histories
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="content">
            <table id="tbCustomer" class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Full name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Balance</th>
                        <th colspan="3">Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- <tr>
                        <td>1</td>
                        <td>NVA</td>
                        <td>nva@co.cc</td>
                        <td>2345</td>
                        <td>28 Nguyễn Tri Phương</td>
                        <td>0</td>
                    </tr> -->
                </tbody>
            </table>
        </div>
    </div>

    
    <!-- Modal Create -->
    <div class="modal fade" id="modalCreateCustomer" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal add new customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="modal-alert-danger hide"></div>

                <form action="" id="frmCreate">
                    <div class="row">
                        <div class="col-lg-6 mt-3">
                            <label for="fullNameCre">Full name</label>
                            <input type="text" class="form-control" id="fullNameCre" name="fullNameCre">
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="emailCre">Email</label>
                            <input type="email" class="form-control" id="emailCre" name="emailCre">
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="phoneCre">Phone</label>
                            <input type="tel" class="form-control" id="phoneCre" name="phoneCre">
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="addressCre">Address</label>
                            <input type="text" class="form-control" id="addressCre" name="addressCre">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" id="btnCreate">Create</button>
            </div>
        </div>
        </div>
    </div>


    <!-- Modal Update -->
    <div class="modal fade" id="modalUpdateCustomer" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal update customer's information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" id="frmUpdate">
                    <input type="hidden" id="customerIdUp">
                    <div class="row">
                        <div class="col-lg-6 mt-3">
                            <label for="fullNameUp">Full name</label>
                            <input type="text" class="form-control" id="fullNameUp">
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="emailUp">Email</label>
                            <input type="email" class="form-control" id="emailUp" readonly>
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="phoneUp">Phone</label>
                            <input type="tel" class="form-control" id="phoneUp">
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="addressUp">Address</label>
                            <input type="text" class="form-control" id="addressUp">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-success" id="btnUpdate">Update</button>
            </div>
        </div>
        </div>
    </div>

    <!-- Modal Withdraw -->
    <div class="modal fade" id="modalWithdraw" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal withdraw money</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="" id="frmWithdraw">
                    <div class="row">
                        <div class="col-lg-6 mt-3">
                            <label for="customerIdWd">Customer Id</label>
                            <input type="text" class="form-control" id="customerIdWd" readonly>
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="fullNameWd">Full name</label>
                            <input type="text" class="form-control" id="fullNameWd" readonly>
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="balanceWd">Current balance ($)</label>
                            <input type="text" class="form-control" id="balanceWd" readonly>
                        </div>
                        <div class="col-lg-6 mt-3">
                            <label for="transactionAmountWd">Transaction Amount ($)</label>
                            <input type="text" class="form-control" id="transactionAmountWd">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-warning" id="btnWithdraw">Withdraw</button>
            </div>
        </div>
        </div>
    </div>
  

    <script src="/assets/jquery/v3.6.1/jquery-3.6.1.min.js"></script>
    <script src="/assets/bootstrap/v5.2/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/fontawesome/v5.15.4/js/all.min.js"></script>
    <script src="/assets/sweetalert2/sweetalert2.all.min.js"></script>
    <script src="/assets/jquery-validate/1.19.3/jquery.validate-1.19.3.min.js"></script>
    <script src="/assets/js/app.js"></script>

    <script>

        let customer = new Customer();
        let withdraw = new Withdraw();

        function renderCustomer(obj) {
            let str = `
                <tr id="tr_${obj.id}">
                    <td>${obj.id}</td>
                    <td>${obj.fullName}</td>
                    <td>${obj.email}</td>
                    <td>${obj.phone}</td>
                    <td>${obj.address}</td>
                    <td>${obj.balance}</td>
                    <td>
                        <button class="btn btn-outline-primary edit" data-id="${obj.id}"
                            data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>    
                    </td>
                    <td>
                        <button class="btn btn-outline-warning withdraw" data-id="${obj.id}"
                            data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Withdraw">
                            <i class="fas fa-minus"></i>
                        </button>    
                    </td>
                    <td>
                        <button class="btn btn-outline-danger delete" data-id="${obj.id}"
                            data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete">
                            <i class="far fa-trash-alt"></i>
                        </button>    
                    </td>
                </tr>
            `;
            
            return str;
        }


        function loadCustomers() {
            $.ajax({
                headers: {
                    accept: "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: "http://localhost:4000/customers?deleted=0"
            })
            .done((data) => {
                let tbCustomer = $("#tbCustomer tbody");

                data.forEach(item => {
                    let str = renderCustomer(item);
                    tbCustomer.prepend(str);
                });

                enableTootip();

                removeHandleShowModal();

                handleShowGroupModal();
            })
            .fail((jqXHR) => {
                console.log(jqXHR);
            })
        }

        loadCustomers();

        function getCustomerById(customerId) {
            return $.ajax({
                headers: {
                    accept: "application/json",
                    "content-type": "application/json"
                },
                type: "GET",
                url: "http://localhost:4000/customers/" + customerId
            })
            .done((data) => {
                customer = data;
            })
            .fail((jqXHR) => {
                console.log(jqXHR);
            })
        }


        function doCreate() {
            customer.fullName = $("#fullNameCre").val();
            customer.email = $("#emailCre").val();
            customer.phone = $("#phoneCre").val();
            customer.address = $("#addressCre").val();
            customer.balance = 0;
            customer.deleted = 0;

            $.ajax({
                headers: {
                    accept: "application/json",
                    "content-type": "application/json"
                },
                type: "POST",
                url: "http://localhost:4000/customers",
                data: JSON.stringify(customer)
            })
            .done((data) => {
                let tbCustomer = $("#tbCustomer tbody");
                let str = renderCustomer(data);
                tbCustomer.prepend(str);

                enableTootip();

                removeHandleShowModal();

                handleShowGroupModal();

                $("#modalCreateCustomer").modal("hide");
            })
            .fail((jqXHR) => {
                console.log(jqXHR);
            })
        }


        let btnCreate = $("#btnCreate");
        btnCreate.on("click", () => {
            $("#frmCreate").submit();
        })

        let btnUpdate = $("#btnUpdate");
        btnUpdate.on("click", () => {
            let customerId = $("#customerIdUp").val();

            customer.fullName = $("#fullNameUp").val();
            customer.phone = $("#phoneUp").val();
            customer.address = $("#addressUp").val();

            let obj = {
                fullName: $("#fullNameUp").val(),
                phone: $("#phoneUp").val(),
                address: $("#addressUp").val(),
            }

            $.ajax({
                headers: {
                    accept: "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: "http://localhost:4000/customers/" + customerId,
                data: JSON.stringify(obj)
            })
            .done((data) => {
                let str = renderCustomer(data);

                let updateRow = $("#tr_" + customerId);
                updateRow.replaceWith(str);

                enableTootip();

                removeHandleShowModal();

                handleShowGroupModal();

                $("#modalUpdateCustomer").modal("hide");
            })
            .fail((jqXHR) => {
                console.log(jqXHR);
            })
        })

        let btnWithdraw = $("#btnWithdraw");
        btnWithdraw.on("click", () => {
            let customerId = $("#customerIdWd").val();

            let transactionAmount = +$("#transactionAmountWd").val();

            if (customer.balance < transactionAmount) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Current balance not enough to withdraw transaction!',
                })
            }
            else {
                customer.balance = customer.balance - transactionAmount;

                delete withdraw.id;
                withdraw.customerId = customer.id;
                withdraw.transactionAmount = transactionAmount;

                reduceBalance(customerId).then(() => {
                    insWithdraw();
                })
                .catch(() => {
                    alert("Withdraw error");
                });
                

            }
        })

        function reduceBalance(customerId) {
            return $.ajax({
                headers: {
                    accept: "application/json",
                    "content-type": "application/json"
                },
                type: "PATCH",
                url: "http://localhost:4000/customers/" + customerId,
                data: JSON.stringify(customer)
            })
            .done((data) => {
                customer = data;
            })
            .fail((jqXHR) => {
                console.log(jqXHR);
            })
        }

        function insWithdraw() {
            $.ajax({
                headers: {
                    accept: "application/json",
                    "content-type": "application/json"
                },
                type: "POST",
                url: "http://localhost:4000/withdraws",
                data: JSON.stringify(withdraw)
            })
            .done(() => {
                let str = renderCustomer(customer);

                let updateRow = $("#tr_" + customer.id);
                updateRow.replaceWith(str);

                enableTootip();

                removeHandleShowModal();

                handleShowGroupModal();

                $("#modalWithdraw").modal("hide");
            })
            .fail((jqXHR) => {
                console.log(jqXHR);
            })
        }


        function handleShowUpdateModal() {
            $(".edit").on("click", function() {

                console.log("Edit");
                let customerId = $(this).data("id");
                
                getCustomerById(customerId).then(() => {
                    $("#customerIdUp").val(customerId);
                    $("#fullNameUp").val(customer.fullName);
                    $("#emailUp").val(customer.email);
                    $("#phoneUp").val(customer.phone);
                    $("#addressUp").val(customer.address);

                    $("#modalUpdateCustomer").modal("show");
                }).catch(() => {
                    alert("Error");
                });
            })
        }

        function handleShowWithdrawModal() {
            $(".withdraw").on("click", function() {

                let customerId = $(this).data("id");
                
                getCustomerById(customerId).then(() => {
                    $("#customerIdWd").val(customerId);
                    $("#fullNameWd").val(customer.fullName);
                    $("#balanceWd").val(customer.balance);

                    $("#modalWithdraw").modal("show");
                }).catch(() => {
                    alert("Error");
                });
            })
        }

        function handleShowConfirmDelete() {
            $(".delete").on("click", function() {
                let customerId = $(this).data("id");

                getCustomerById(customerId).then(() => {
                    Swal.fire({
                        title: 'Are you sure?',
                        text: "You won't be able to revert this!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'Yes, delete it!'
                    }).then((result) => {
                        if (result.isConfirmed) {

                            customer.deleted = 1;

                            $.ajax({
                                headers: {
                                    accept: "application/json",
                                    "content-type": "application/json"
                                },
                                type: "PATCH",
                                url: "http://localhost:4000/customers/" + customerId,
                                data: JSON.stringify(customer)
                            })
                            .done((data) => {
                                $("#tr_" + customerId).remove();
                                Swal.fire(
                                    'Deleted!',
                                    'The client has been deleted.',
                                    'success'
                                )
                            })
                            .fail((jqXHR) => {
                                console.log(jqXHR);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Oops...',
                                    text: 'Something went wrong!',
                                })
                            })
                        }
                    })
                })
                .catch(() => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Customer ID invalid',
                    })
                })

                
            });
        }

        function handleShowGroupModal() {
            handleShowUpdateModal();

            handleShowWithdrawModal();

            handleShowConfirmDelete();
        }

        function removeHandleShowModal() {
            $(".edit").off("click");
            $(".withdraw").off("click");
            $(".delete").off("click");
        }


        function enableTootip() {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }


        $("#modalCreateCustomer").on("hidden.bs.modal", () => {
            $("#modalCreateCustomer .modal-alert-danger").empty().removeClass("show").addClass("hide");
        })


        $("#frmCreate").validate({
            rules: {
                fullNameCre: {
                    required: true,
                    minlength: 5,
                    maxlength: 35
                },
                emailCre: {
                    required: true,
                    minlength: 5,
                    maxlength: 35,
                    email: true
                }
            },
            messages: {
                fullNameCre: {
                    required: "Vui lòng nhập tên đầy đủ",
                    minlength: "Độ dài tối thiểu là 5 ký tự",
                    maxlength: "Độ dài tối đa là 35 ký tự"
                },
                emailCre: {
                    required: "Vui lòng nhập email đầy đủ",
                    minlength: "Độ dài tối thiểu là 5 ký tự",
                    maxlength: "Độ dài tối đa là 35 ký tự",
                    email: "Vui lòng nhập đúng định dạng email"
                }
            },
            errorLabelContainer: "#modalCreateCustomer .modal-alert-danger",
            errorPlacement: function (error, element) {
                error.appendTo("#modalCreateCustomer .modal-alert-danger");
            },
            showErrors: function(errorMap, errorList) {
                if (this.numberOfInvalids() > 0) {
                    $("#modalCreateCustomer .modal-alert-danger").removeClass("hide").addClass("show");
                } else {
                    $("#modalCreateCustomer .modal-alert-danger").removeClass("show").addClass("hide").empty();
                    $("#frmCreate input.error").removeClass("error");
                }
                this.defaultShowErrors();
            },
            submitHandler: function () {
                doCreate();
            }
        })
        
        


    </script>
</body>
</html>